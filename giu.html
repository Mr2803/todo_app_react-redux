<script src="https://js.stripe.com/v3/"></script>

<!-- SAVE DI CARD -->
<script>
  function acceptOrder() {
    console.log("acceptOrder");
    fetch(
      "{{ $urlBase }}/api/stripe/payWithSaveCard?token=6d10f35d-6ba4-4e11-ba52-4221ff870809",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: 10000,
          currency: "eur",
          //customer: document.getElementById("setup-form").getAttribute('customer-id'),
          //payment_method: document.getElementById("setup-form").getAttribute('payment_method'),
          email_account: "eraldolattari+l7@gmail.com",
          application_fee_amount: 100,
          order_id: "xyz",
        }),
      }
    ).then(function (result) {
      // Handle server response (see Step 4)
      console.log(result);
      result.json().then(function (json) {
        alert(json);
      });
    });
  }
</script>
<input id="cardholder-name" type="text" />
<!-- placeholder for Elements -->
<form
  onsubmit="return false;"
  id="setup-form"
  data-secret=""
  payment_method=""
  customer-id=""
>
  <div id="card-element"></div>
  <button id="card-button">Save Card</button>
</form>
<button onclick="acceptOrder()">Accept Order</button>
<script>
  var stripe = Stripe("pk_test_JKFmwJZHV0xX1eEmDXMbLXlT00NKrcGN86");
  var elements = stripe.elements();
  var cardElement = elements.create("card");
  cardElement.mount("#card-element");
  var cardholderName = document.getElementById("cardholder-name");
  var cardButton = document.getElementById("card-button");
  var clientSecret = cardButton.dataset.secret;
  cardButton.addEventListener("click", function (ev) {
    fetch(
      "{{ $urlBase }}/api/stripe/getClientSecret?order_id=xyz&email_account=federica.passanante+testpagamenti@gmail.com",
      {
        method: "GET",
        headers: { "Content-Type": "application/json" },
      }
    ).then(function (result) {
      // Handle server response (see Step 4)
      result.json().then(function (json) {
        clientSecret = json.client_secret;
        customerId = json.customer_id;
        document
          .getElementById("setup-form")
          .setAttribute("data-secret", clientSecret);
        document
          .getElementById("setup-form")
          .setAttribute("customer-id", customerId);
        //------ SALVA CARTA
        stripe
          .confirmCardSetup(clientSecret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                name: cardholderName.value,
              },
            },
          })
          .then(function (result) {
            if (result.error) {
              alert("error01" + result.error.message);
            } else {
              alert("ok-01");
              document
                .getElementById("setup-form")
                .setAttribute(
                  "payment_method",
                  result.setupIntent.payment_method
                );
              fetch("{{ $urlBase }}/api/stripe/savePaymentMethod", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  order_id: "xyz",
                  payment_method: result.setupIntent.payment_method,
                }),
              }).then(function (result) {
                alert("payment_method saved");
              });
            }
          });
      });
    });
  });
</script>
